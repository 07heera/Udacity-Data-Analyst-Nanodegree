TITLE by YOUR_NAME_HERE
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(ggthemes)
library(dplyr)
library(gridExtra)
library(tidyr)
library(MASS)
library(scales)
library(GGally)
```

#Abstract
Prosper.com is a P2P lending marketplace, similarly with LendingClub.com, with the notorious IPO in 2014. Prosper Loan data provided by Udacity was last updated 3/11/2014


```{r echo=FALSE, Load_the_Data}
# Load the Data
getwd()
setwd('/Users/tommyly/Documents/Udacity/p4/data')
# Read the csv file
prosper = read.csv("prosperLoanData.csv")
```

Structure of the dataset
```{r echo=FALSE, data_structure}
names(prosper)
str(prosper)
nrow(prosper)
ncol(prosper)
prosper$ProsperRating.alpha = factor(prosper$ProsperRating..Alpha.,
                                 levels = c("AA","A","B","C","D","E","HR","NA"))
prosper$ProsperRating <-
  factor(prosper$ProsperRating..Alpha,
         levels = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR', 'NA'))
prosper$ProsperScore = factor(prosper$ProsperScore)

```

# Univariate Plots Section

##1. Borrower Rating from Prosper
```{r echo=FALSE, Univariate_Plots}
ggplot(data = prosper, aes(ProsperRating.alpha)) +
  geom_histogram(aes(fill = ProsperRating.alpha)) +
  ggtitle('Borrower Rating from Prosper') +
  xlab('Rating') +
  ylab('Number of Loans')
```

##2. Borrower Score from Prosper
```{r}
ggplot(data = prosper, aes(x = ProsperScore)) + 
        geom_bar(color = "black", fill = '#007EE5') +
        theme(axis.text.x = element_text(angle = 60, vjust = 0.6)) +
        xlab("Score") + ggtitle("Borrower Score from Prosper")
```

##3. Income Range
```{r echo=FALSE, Univariate_Plots}
prosper$IncomeRange = factor(prosper$IncomeRange, 
                             levels=c("Not employed", "$0", "$1-24,999", 
                                    "$25,000-49,999", "$50,000-74,999", 
                                    "$75,000-99,999", "$100,000+", 
                                    "Not displayed"))
ggplot(data = prosper, aes(IncomeRange)) +
  geom_bar(color="black", fill = '#007EE5') +
  ggtitle('Borrower Income Range') +
  xlab('Income') +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.6)) +
  ylab('Count')
```

##4. Debt to Income Ratio
```{r}
ggplot(data = prosper, aes(x = DebtToIncomeRatio)) +                
        geom_histogram(color = "black", fill = '#007EE5', binwidth = 0.05) +
        xlim(0, quantile(prosper$DebtToIncomeRatio, prob = 0.99, na.rm=TRUE)) +
        ggtitle("Debt To Income Ratio") +
        xlab("Debt to Income Ratio") +
        ylab("Count")
```

##5. Borrower's Purpose of Loan 

```{r}
x <- c('Debt Consolidation', 
                                'Home Improvement','Business', 
                                 'Personal Loan', 
                                 'Student Use', 
                                 'Auto', 
                                 'Baby & Adoption',
                                 'Boat', 
                                 'Cosmetic Procedure', 
                                 'Engagement Ring', 
                                 'Green Loans', 
                                 'Household Expenses', 
                                 'Large Purchases', 
                                 'Medical/Dental', 
                                 'Motorcycle', 'RV',
                                 'Taxes', 'Vacation',
                                 'Wedding Loans', 
                                 'Other', 
                                 'Not Available')
prosper$ListingCategory <- factor(prosper$ListingCategory..numeric., 
                                  levels = c(1:6,8:20,7,0), labels = x)

ggplot(prosper, aes(ListingCategory, ymax = max(..count..))) +
  geom_bar(color="black", fill = '#007EE5') +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.6)) + 
        stat_bin(geom="text", binwidth = 500, size = 3,
                 aes(label=..count.., vjust=-0.9, hjust=0.5)) +
        ggtitle("The Purpose of the Loan Listing") +
        xlab("Listing Category") +
        ylab("Number of loans")
```

## 6. Number of Loans split by Year
```{r}
# set Loan Orignal Date in Year-Month-Date format
prosper$LoanOriginationDate <- as.POSIXct(prosper$LoanOriginationDate, format="%Y-%m-%d")

prosper$LoanOriginationDate.year <-prosper$LoanOriginationDate %>%
                                                  format('%Y') %>%
                                                          strtoi()
ggplot(prosper, aes(as.factor(LoanOriginationDate.year))) +
  geom_histogram(color = 'black', fill = '#007EE5') +
  ggtitle('Number of Loans by Year') +
  stat_bin(geom="text", aes(label=..count.., vjust=-0.9, hjust=0.5)) +
  xlab('Year') +
  ylab('Number of Loans')
```

## 7. Number of Loans split by Month
```{r}
months <- c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')

prosper$LoanOriginationDate.month=format(prosper$LoanOriginationDate, "%b")
ggplot(prosper, aes(LoanOriginationDate.month)) +
  geom_histogram(color = 'black', fill = '#007EE5') +
  facet_wrap(~LoanOriginationDate.year) +
  ggtitle('Number of Loans by Month') +
  xlab('Month') +
  ylab('Number of Loans')

```

## 9. Number of Loan Split by Amount
```{r}
ggplot(prosper, aes(LoanOriginalAmount)) + 
  geom_histogram(binwidth = 2000) +
  scale_x_continuous(
    limits = c(0,quantile(prosper$LoanOriginalAmount, 0.99, na.rm = TRUE)),
    breaks = seq(0, quantile(prosper$LoanOriginalAmount, 0.99, na.rm = TRUE), 2000)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##10. Employment status
```{r}
ggplot(aes(x = EmploymentStatus), data = prosper) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

##11. Annual income
```{r}
ggplot(aes(x = StatedMonthlyIncome), data = prosper) +
  geom_histogram(binwidth = 500) +
    scale_x_continuous(
      limits = c(0, quantile(prosper$StatedMonthlyIncome, 0.99, na.rm = TRUE)),
      breaks = seq(0, quantile(prosper$StatedMonthlyIncome, 0.99, na.rm = TRUE), 1000)) +
  theme(axis.text.x = element_text(angle = 90))
```

## 12. Employment length
```{r}
ggplot(aes(x=EmploymentStatusDuration/12), 
       data=subset(prosper, 
                   EmploymentStatus %in% 
                       c("Employed", "Full-time", 
                         "Part-time", "Self-employed"))) + 
    geom_histogram(binwidth = 1, fill='#007EE5', color='black') +
    labs(title='Length of Employment', x='years of employment') +
    scale_x_continuous(breaks=seq(0, quantile(prosper$EmploymentStatusDuration, 0.99, na.rm = TRUE), 1))
```

##13. Borrower's Rate
```{r}
ggplot(data = prosper, aes(x = BorrowerRate)) + 
        geom_histogram(color = "black", fill = '#007EE5', binwidth = 0.01) +
        xlab("Rate") +
        ggtitle("Borrower Rate") 
```

## 14.  Most common term loan
```{r}
prosper$Term <- factor(prosper$Term)
ggplot(data = prosper, aes(x = Term, ymax = max(..count..))) + 
        geom_bar(fill='#007EE5') +
        stat_bin(geom="text", size = 4,
                 aes(label=..count.., vjust=-0.9))+
        ggtitle("Length of the Loan")
```

## 15. Investor perspective
```{r}
ggplot(aes(x=LenderYield), data=prosper) + 
    geom_histogram(binwidth=0.005,fill = '#007EE5', color='black') +
    scale_x_continuous(breaks=seq(0, 0.5, 0.05)) + 
    ggtitle("The Lender Yield on the Loan")
```

## 16. Number of investors invest in a loan
```{r}
ggplot(aes(x=Investors), data= prosper) + 
    geom_histogram(binwidth=10, 
                   fill= '#007EE5', color='black') +
    labs(title="The Number of Investors Funded the Loan\n ")
table(prosper$Investors==1)

```

# Univariate Analysis

### What is the structure of your dataset?

### What is/are the main feature(s) of interest in your dataset?

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

### Did you create any new variables from existing variables in the dataset?

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?


# Bivariate Plots Section

## 1. GGPairs sample
```{r echo=FALSE, Bivariate_Plots}
prosper$BorrowerAPR <- factor(prosper$BorrowerAPR)
prosper$BorrowerState <- factor(prosper$BorrowerState)

prosper.sample <- sample_n(prosper, 500)

#Borrower Profile
ggpairs(prosper.sample[ ,c("IncomeRange",
                          "ProsperScore",       
                          "LoanOriginalAmount", 
                          "StatedMonthlyIncome", 
                          "DebtToIncomeRatio",
                          "EmploymentStatus",
                          "BorrowerRate",
                          "BorrowerAPR"
                          )],
        diag=list(continuous="density", 
                  discrete="bar"), 
        axisLabels="none")

#Investor Profile Profile
ggpairs(prosper.sample[ ,c("LenderYield",
                   "ProsperRating..Alpha.",
                   "BorrowerAPR",
                   "LoanOriginalAmount", 
                   "ListingCategory")],
        diag=list(continuous="density", 
                  discrete="bar"), 
        axisLabels="none")
```

##2.Prosper Data - BorrowerRate - Prosper Rating Numeric
```{r}
prosper$ProsperRating..numeric. <- factor(prosper$ProsperRating..numeric.)
ggplot(data = prosper, aes(x = ProsperRating..numeric., y = BorrowerRate)) +
        geom_boxplot(aes(fill = ProsperRating..numeric.)) +
        xlab("Prosper Rating") +
        ggtitle("Borrower Rate for Different Prosper Rating")
```

##3. Loan Status per Rating
```{r}
#Transfrom and lign up variable

#prosper$ProsperRating..numeric. <- ordered(prosper$ProsperRating..numeric., 
#                        labels = rev(c("HR", "E", "D", "C", "B", "A", "AA")))
#ratinglevels <- rev(c("HR", "E", "D", "C", "B", "A", "AA"))

#prosper <- prosper %>% 
#          mutate(Rating = ifelse(ProsperRating..numeric. %in% ratinglevels, 
#                                 as.character(ProsperRating..numeric.), 
#                                 ifelse(CreditGrade %in% ratinglevels,
#                                        as.character(CreditGrade),
#                                        NA)))
#prosper$Rating <- ordered(prosper$Rating, labels = ratinglevels)

# create a new variable summarizing the result of each loan
prosper <- prosper %>% mutate(Status = ifelse(LoanStatus %in%
                     c("Chargedoff", "Defaulted"), 0,
                     ifelse(LoanStatus %in% 
                     c("Completed", "Current", "FinalPaymentInProgress"), 2, 
                     ifelse(LoanStatus %in% 
                     "Cancelled",3,1))))
prosper$Status <- factor(prosper$Status, levels = 0:3, 
                         labels = c("Defaulted", "Past Due", "Current or Paid","Cancelled"))

ggplot(data = arrange(prosper,Status), aes(x = ProsperRating.alpha, 
                      y = LoanOriginalAmount, fill = Status)) +
                      geom_bar(stat = "identity") +
                      xlab("Prosper Rating") +
                      xlab("Original Loan Amount") +
        ggtitle("Orignal Loan Amount for Different Prosper Rating")
```

##4. Borrower Profile - Yearly Income ~ Prosper Rating Categorial
```{r}
ggplot(aes(y = StatedMonthlyIncome *12 , x =ProsperRating.alpha ), 
       data = subset(prosper,prosper$StatedMonthlyIncome > 0 &
                       prosper$StatedMonthlyIncome < 9000)) +
      geom_boxplot(aes(fill = ProsperRating..numeric.)) +
      xlab("Prosper Rating") +
      ylab("Yearly Income") +
      ggtitle("Yearly Income for Different Prosper Rating")
```

##5. Borrower Profile - Employment Status ~ LoanOriginalAmount
```{r}
ggplot(aes(x = EmploymentStatus, y = LoanOriginalAmount), data = prosper) +
  geom_boxplot(aes(fill = EmploymentStatus)) +
  scale_y_continuous(limits = c(0,15000)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


##5.5 Borrower Profile - Borrower Rate ~ Debt to Income Ratio - Scatter Plot
```{r}
ggplot(aes(x = DebtToIncomeRatio  , y = BorrowerRate), data = prosper) +
  geom_point(alpha = 0.05, position = "jitter") +
  stat_quantile(quantiles = 0.5) +
  scale_x_continuous(limits = c(0, quantile(prosper$DebtToIncomeRatio, 0.99, na.rm = TRUE))) +
  scale_y_continuous(limits = c(0, quantile(prosper$BorrowerRate, 0.99, na.rm = TRUE)))
```


##6. Borrower Profile - Borrower Rate ~ Debt to Income Ratio
```{r}
prosper$DebtToIncomeRatio.bucket <- with(prosper, cut(as.numeric(DebtToIncomeRatio), 
                                         c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 
                                           0.6, 0.7, 0.8, 0.9, 1,
                                           10)))
prosper$DebtToIncomeRatio.bucket <- factor(prosper$DebtToIncomeRatio.bucket,
                             labels = c("0-10%","10-20%", "20-30%", "30-40%",
                                      "40-50%", "50-60%", "60-70%", "70-80%",
                                      "80-90%", "90-100%", ">100%"))

ggplot(aes(x = DebtToIncomeRatio.bucket, y = BorrowerRate), data = prosper) +
  geom_boxplot(aes(fill = DebtToIncomeRatio.bucket)) +
  ylab("Borrower Rate") +
  xlab ("Debt To Income Ratio Bucket")
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#7 Investor profile - Lender Yield vs Rating 
```{r}
prosper$ProsperRating.alpha = factor(prosper$ProsperRating..Alpha.,
                                 levels = c("AA","A","B","C","D","E","HR",""))
ggplot(data = prosper, aes(x = ProsperRating.alpha, y = LenderYield)) +
        geom_boxplot(aes(fill = ProsperRating.alpha)) +
        xlab("Prosper Rating") +
        ggtitle("Yield for Different Prosper Rating")
```

##8. Investor profiel - Lender Yield vs Listing Category
```{r}
ggplot(data = prosper, aes(x = ListingCategory, y = LenderYield)) +
        geom_boxplot() +
        xlab("Category") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.6)) +
        ggtitle("Lender Yield for Different Listing Category")
```

##9. Investor Profile - LoanOriginal Amount ~ Term
```{r}
ggplot(aes(y = LoanOriginalAmount, x = Term), data = prosper) +
  geom_boxplot() +
  scale_y_continuous(
    limits = c(0, quantile(prosper$LoanOriginalAmount, 0.99, na.rm = TRUE)))
```

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

### What was the strongest relationship you found?




# Multivariate Plots Section

#1. Debt To Income Ratio - Prosper Rating - Lender Yield
```{r echo=FALSE, Multivariate_Plots}
ggplot(aes(x= DebtToIncomeRatio.bucket, y=LenderYield, 
                 color=ProsperRating.alpha), 
       data=na.omit(filter(prosper, DebtToIncomeRatio < 1))) +
    geom_point(alpha = 0.5, position = "jitter") +
    scale_y_log10() +
    facet_grid(.~ ProsperRating.alpha ) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ggtitle("Lender Yield (Log 10) vs Debt to Income Ratio 
            and Prosper Rate")
```

#2. Lender Yield vs Prosper Rate vs Term
```{r}
plot1 <- ggplot(aes(x= ProsperRating.alpha, y=LenderYield, 
                 color=ProsperRating.alpha), 
       data=na.omit(filter(prosper, DebtToIncomeRatio < 1))) +
    geom_point(alpha = 0.8, position = "jitter") +
    facet_grid( .~ Term  ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    ggtitle("Lender Yield vs Term
            and Prosper Rate")

plot2 <- ggplot(aes(x= ProsperRating.alpha, y= LenderYield ), 
       data=na.omit(filter(prosper, DebtToIncomeRatio < 1))) +
    geom_boxplot(aes(fill = ProsperRating.alpha)) +
    facet_grid( .~ Term   ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    ggtitle("Lender Yield vs Term and Prosper Rate")

grid.arrange(plot1, plot2, ncol=1, nrow =2)
```

#3. Borrower Rate vs Year vs Prosper Rating
```{r}
ggplot(aes(x= ProsperRating.alpha, y= BorrowerRate ), 
       data=na.omit(filter(prosper))) +
    geom_boxplot(aes(fill = ProsperRating.alpha)) +
    facet_grid( .~ LoanOriginationDate.year) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    ggtitle("Lender Yield vs Term and Prosper Rate")

```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection
